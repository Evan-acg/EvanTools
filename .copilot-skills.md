## 核心基础设施指令 (Infrastructure)

在执行任何具体技能前，必须遵循以下环境管理规范：

- **创建环境 (Init):** `git worktree add ../worktrees/{task_name} -b {branch_name}`
- 清理环境 (Cleanup):
  - 合并分支: `git checkout master && git merge {branch_name}`
  - 删除工作区: `git worktree remove ../worktrees/{task_name} --force`
  - 清理残留: 删除所有 `__pycache__`、`.pytest_cache` 及任务产生的临时 `.log` 或 `.plan` 文件。
  - 删除分支: `git branch -d {branch_name}`

## 通用元流程 (Meta-Workflow)

**所有技能必须严格遵守以下执行协议：**

1. **创建工作区:** 建立物理隔离环境。
2. **建立基准:** 运行测试，确保初始状态为 Green。
3. **生成计划 (Critical):** 在工作区docs目录中创建 `{task_name}_PLAN.md`，列出所有待执行任务。
4. **子代理分步执行:** 每完成计划中的一项，更新 `{task_name}_PLAN.md` 状态为 `[x]`。
5. **循环验证:** 每一小步执行后需运行相关测试或检查。

## 技能库 （Skill Set）

### 1. 深度重构与脑暴 (Brainstorm-Refactor)

- **Step 1:** 创建 Worktree。
- **Step 2 [Brainstorm]:** 分析 XXX 的现状，输出头脑风暴报告。
- **Step 3 [Planning]:** 基于脑暴结果，在 `{task_name}_PLAN.md` 中生成重构任务清单。
- **Step 4 [Execution]:** 按照 `{task_name}_PLAN.md` 逐条重构。
- **Step 5 [Verify]:** 运行测试，确保功能一致性。
- **Step 6:** Cleanup。

### 2. SOLID 工程实践 (SOLID & Software Engineering)

- **Step 1:** 创建 Worktree。
- **Step 2 [Baseline]:** 编写/运行基准测试。
- **Step 3 [Analysis]:** 识别违反 SOLID 的点，在 `{task_name}_PLAN.md` 中列出重构目标（如：提取接口、职责拆分）。
- **Step 4 [Execution]:** 逐条执行，每步都要保证代码可运行。
- **Step 5 [Verify]:** 运行最终测试。
- **Step 6:** Cleanup。

### 3. 代码物理拆分与重组 (Decomposition)

- **Step 1:** 创建 Worktree 并运行基准测试。
- **Step 2 [Mapping]:** 分析类/方法引用关系，在 `{task_name}_PLAN.md` 中生成物理移动清单（从 A 移到 B）。
- **Step 3 [Execution]:** * 按照计划物理移动文件。
  - 修正 Import。
  - 更新 `__init__.py`。
- **Step 4 [Verify]:** 运行路径和导入检查，运行测试。
- **Step 5:** Cleanup。

### 4. Pylance 修正与功能审计 (Diagnostic & Audit)

- **Step 1:** 创建 Worktree 并运行基准测试。
- **Step 2 [Scan]:** 运行 Pylance，在 `{task_name}_PLAN.md` 中列出所有 Error 及其修复方案。
- **Step 3 [Audit]:** 检查合规性（如：是否使用 `evan_tools.md5`），将违规项加入 `{task_name}_PLAN.md`。
- **Step 4 [Execution]:** 逐一勾选修复。
- **Step 5 [Verify]:** 运行静态检查（报错归零）和动态测试。
- **Step 6:** Cleanup。

### 5. 零注释 & 中文 Google Docstring (Documentation)

- **Step 1:** 创建 Worktree 并运行基准测试。
- **Step 2 [Plan]:** 扫描目标文件，在 `{task_name}_PLAN.md` 中列出需要更新文档的文件列表。
- **Step 3 [Clean]:** 批量移除旧注释。
- **Step 4 [Execution]:** 逐个文件生成中文 Google 风格 Docstring。
- **Step 5 [Verify]:** 运行测试。
- **Step 6:** Cleanup。

## 强制约束 (Constraints)

   1. **禁止跳步:** 严禁在没有更新 `{task_name}_PLAN.md` 的情况下直接修改代码。
   2. **即时反馈:** 每一项 `[x]` 完成后，向用户简要汇报变更内容。
   3. **原子提交:** 建议在工作区内每完成计划的一个大项，执行一次 `git commit`。
